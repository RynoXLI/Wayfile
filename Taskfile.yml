# yaml-language-server: $schema=https://taskfile.dev/schema.json

version: '3'

vars:
  GREETING: Hello, world!

tasks:
  migrate:
    desc: Run database migrations
    cmds:
      - go tool tern migrate -m ./migrations

  sqlc:
    desc: Generate SQLC code
    cmds:
      - go tool sqlc generate -f sqlc.yaml

  protobuf:
    desc: Generate protobuf code using Buf
    cmds:
      - go tool buf generate

  tidy:
    desc: Tidy Go modules
    cmds:
      - go mod tidy

  fmt:
    desc: Format Go code
    cmds:
      - golangci-lint fmt

  lint:
    desc: Run linters
    deps:
      - fmt
    cmds:
      - golangci-lint run

  lint-fix:
    desc: Run linters and auto-fix issues
    cmds:
      - golangci-lint run --fix

  test:
    desc: Run unit tests
    cmds:
      - go test ./...

  test:int:
    desc: Run integration tests
    cmds:
      - go test -tags=integration ./... -v

  check:
    desc: Run all checks (format, lint, test)
    cmds:
      - task: fmt
      - task: lint
      - go test ./...

  dev:
    desc: Run the API server
    deps:
      - tidy
      - migrate
      - protobuf
      - sqlc
    cmds:
      - go tool air

  openapi:
    desc: Download OpenAPI 3.0 spec from running server
    cmds:
      - curl -s http://localhost:8080/openapi-3.0.yaml > openapi.yaml
      - echo "OpenAPI 3.0.3 spec saved to openapi.yaml"

  client:
    desc: Generate Go client from OpenAPI spec
    deps:
      - openapi
    cmds:
      - mkdir -p gen/client
      - oapi-codegen -generate types,client -package client openapi.yaml > gen/client/client.go
      - echo "Client generated in gen/client/client.go"